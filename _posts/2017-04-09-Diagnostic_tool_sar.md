---
title: sar
published: true
date: '2017-04-10 04:11:00 +0300'
tags: tools
categories: work
---
## Sar - system actiity report

`sar` - утилита, распространаяющаяся с пакетом sysstat, собирающая информацию о системной активности.

Благодаря отчетам сгенерированным утилитой `sar` можно много узнать о производительности вашей системы.

Главный конфигурационный файл для утилиты может находится тут: `/etc/sysconfig/sysstat` или тут: `/etc/sysstat/sysstat`

Основной директивы для конфига следующие:

```
history=7 `# указывает сколько дней будут хранится лог-файлы`
SA_DIR=/var/log/sysstat `# Указывает директорию для хранений лог-файлов`
```

Версия утилиты использовавшаяся для листингов:

```
sar -V
sysstat version 11.3.5
(C) Sebastien Godard (sysstat <at> orange.fr)
```

##Основной синтаксис утилиты таков:

`sar -REPORT LEN CNT`

синтаксис включает в себя опции:

`REPORT` - однобуквенная опция, указывающая какой отчет запускать, самые часто используемые опции:
`-u` отчет использования CPU.
`-b` отчет использования I/O.
`-d` отчет использования дисков.

`LEN` - опция сообщает утилите через какое колво времени наблюдать за активностью системы в секундах.

`CNT` - опция сообщает утилите сколько раз повторять наблюдения и создание отчетов, если его не указывать то процесс будет продолжаться до тех пор, пока не будет остановлен.

Например:

```
sar -u 5 4
Linux 4.4.0-46-generic (home) 	10.04.2017 	_x86_64_	(2 CPU)

00:47:41        CPU     %user     %nice   %system   %iowait    %steal     %idle
00:47:46        all     44,56      0,80      3,60      0,40      0,00     50,65
00:47:51        all     34,87      1,08      6,56      1,27      0,00     56,22
00:47:56        all     44,05      0,88      3,83      0,20      0,00     51,03
00:48:01        all     28,46      1,00      3,61      0,50      0,00     66,43
Average:        all     38,00      0,94      4,41      0,59      0,00     56,06
```
В указанном листинге показано, что утилита выполнила 4 проверки через каждые 5 секунд.

%user - процент утилизации CPU исполняемыми пользовательскими процессами, например приложениями.
%nice - процент утилизации CPU исполняемыми процессами с учетом их приоритетов.
%system - процент утилизации CPU системными процессами, например ядром.
%iowait - процент времени в течении которого CPU простаивал в ожидании ввода/вывода.
%steal - процент времени, затраченного на принудительное ожидание виртуальным процессором или процессорами, в то время как гипервизор обслуживал другой виртуальный процессор.
%idle - процент времени в течении которого CPU простаивал и не имел запросов ввода/вывода.

```
sar -b 5
Linux 4.4.0-46-generic (home) 	10.04.2017 	_x86_64_	(2 CPU)

02:58:59          tps      rtps      wtps   bread/s   bwrtn/s
02:59:04         0,40      0,00      0,40      0,00     24,00
02:59:09         6,60      0,00      6,60      0,00   1097,60
02:59:14         2,40      0,00      2,40      0,00    329,60
02:59:19         3,40      0,00      3,40      0,00    267,20
02:59:24         2,00      0,20      1,80      1,60    976,00
02:59:29        10,20      0,00     10,20      0,00    152,00
02:59:34         1,00      0,00      1,00      0,00     27,20
02:59:39         3,20      0,00      3,20      0,00    819,20
02:59:44         1,80      1,40      0,40    112,00     25,60
02:59:49         5,40      0,20      5,20      1,60    392,00
^C

Average:         3,64      0,18      3,46     11,52    411,04
```
В указанном листинге показано, что утилита выполняла проверки, до получения сигнала 'прерывания' SIGINT.

tps - общее колво запросов в секунду к дисковой подсистеме.
rtps - колво запросов в секунду на чтение к дисковой подсистеме.
wtps - колво запросов в секунду на запись к дисковой подсистеме.
bread/s - общее колво блоков данных прочитанных с дисковой подсистемы за одну секунду. каждый блок данных эквивалентен сектору диска и имеет размер = 512b.
bwrtn/s - общее колво блоков данных записанных на утройство за секунду.

Требуется учесть что чтение и запись данных не всегда производятся  напрямую на диск, иногда для этих процедур используются дисковый буффер - небольшая область памяти диска или кеш в памяти.

```
sar -d 5
Linux 4.4.0-46-generic (home) 	10.04.2017 	_x86_64_	(2 CPU)

03:25:50          DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
03:25:55       dev8-0      2,80      0,00     91,20     32,57      0,01      2,86      2,86      0,80

03:25:55          DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
03:26:00       dev8-0      2,20      1,60    153,60     70,55      0,03     11,64      4,00      0,88

03:26:00          DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
03:26:05       dev8-0     15,40      6,40   8243,20    535,69      0,07      4,31      2,18      3,36

03:26:05          DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
03:26:10       dev8-0      4,60    148,80    214,40     78,96      0,01      1,91      1,91      0,88

03:26:10          DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
03:26:15       dev8-0      7,00      0,00   2273,60    324,80      0,02      2,40      1,49      1,04

03:26:15          DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
03:26:20       dev8-0      5,80      0,00   5137,60    885,79      0,20     35,17      4,28      2,48

03:26:20          DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
03:26:25       dev8-0     15,00      4,80    291,20     19,73      0,14      9,39      0,64      0,96
^C


Average:          DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
Average:       dev8-0      7,54     23,09   2343,54    313,76      0,07      8,91      1,97      1,49
```

DEV
tps - общее колво запросов в секунду к дисковой подсистеме.
rd_sec/s - колво секторов прочитанных с устройства. размер сектора = 512b.
wr_sec/s - колво секторов записанных на устройство.
avgrq-sz - средний размер (в секторах) запросов ввода/вывода для устройства.
avgqu-sz - среднее колво очередей запросов ввода/выводы для устройства.
await - среднее время (в миллисекундах) для запросов ввода/вывода отправленных на устройство, включая время на обслуживание непосредственно этих запросов.
svctm - deprecated field. тоже среднее время для запросов ввода/вывода, которому не стоит доверять т.к опция будет убрана в последующих версиях утилиты.
%util - процента затраченного времени на запросы ввода\вывода, при достижении значений близких к 100% может означать, что есть явные проблемы с производительностью или наличии узких мест в системе таких как диск. В случае выполнении параллельных запросов например при использовании дисковых массивов использующих raid или современные ssd это значение не может корректно указывать на лимиты при выполнении запросов ввода/вывода.

Корреляция времени при использовании опций `-b` и `-d` не является точной, поэтому эти опции можно использовать одновременно:

```
sar -udb 30 2
Linux 4.4.0-46-generic (home) 	10.04.2017 	_x86_64_	(2 CPU)

03:55:50        CPU     %user     %nice   %system   %iowait    %steal     %idle
03:56:20        all     34,03      0,50      5,51      0,44      0,00     59,52

03:55:50          tps      rtps      wtps   bread/s   bwrtn/s
03:56:20         7,10      1,60      5,50     56,27    887,73

03:55:50          DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
03:56:20       dev8-0      7,10     56,27    887,73    132,96      0,04      5,58      1,75      1,24

03:56:20        CPU     %user     %nice   %system   %iowait    %steal     %idle
03:56:50        all     29,81      0,60      3,96      0,59      0,00     65,04

03:56:20          tps      rtps      wtps   bread/s   bwrtn/s
03:56:50         3,37      0,23      3,13      2,13    436,00

03:56:20          DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
03:56:50       dev8-0      3,37      2,13    436,00    130,14      0,02      4,71      2,93      0,99

Average:        CPU     %user     %nice   %system   %iowait    %steal     %idle
Average:        all     31,91      0,55      4,74      0,51      0,00     62,29

Average:          tps      rtps      wtps   bread/s   bwrtn/s
Average:         5,23      0,92      4,32     29,20    661,87

Average:          DEV       tps  rd_sec/s  wr_sec/s  avgrq-sz  avgqu-sz     await     svctm     %util
Average:       dev8-0      5,23     29,20    661,87    132,05      0,03      5,30      2,13      1,11
```

## Sar history

Для просмотра статистики за какой либо из последующи дней необходимо принудительно указать утилите путь до файла с логами. Обычно для этого используется ключ `-f`.

`sar -REPORT -f /usr/adm/sa/DAY`

Например таким образом:

```
sar -u -f /var/log/sa/sa07 | head
Linux 3.10.0+2 (twt-04) 	07.04.2017

00:00:01          CPU     %user     %nice   %system   %iowait    %steal     %idle
00:10:01          all      3,34      0,00     15,20      0,01      0,52     80,93
00:20:01          all      4,01      0,00      5,54      1,21      0,49     88,74
00:30:01          all      4,74      0,00      8,07      7,47      0,56     79,17
00:40:01          all      3,65      0,00      6,12      1,85      0,54     87,84
00:50:01          all      3,13      0,00      4,62      0,01      0,50     91,75
01:00:01          all      2,65      0,00      3,87      0,01      0,51     92,96
01:10:01          all      3,25      0,00      4,62      0,01      0,60     91,53
```
